<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QC FG Scanner</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:white;text-align:center;padding:15px}
#reader{width:100%;max-width:420px;margin:auto}
.card{margin-top:15px;padding:18px;border-radius:14px;font-size:18px}
.good{background:#065f46}
.bad{background:#7f1d1d}
.title{font-size:22px;font-weight:bold;margin-bottom:10px}
input{padding:12px;font-size:16px;border-radius:10px;border:none;width:80%;max-width:320px;margin-top:10px}
button{padding:12px 18px;margin:6px;font-size:16px;border-radius:10px;border:none}
</style>
</head>
<body>
<h2>FG Quality & Traceability</h2>
<div id="reader"></div>
<div id="result"></div>

<div style="margin-top:15px">
<input id="manualCode" placeholder="Input kode manual...">
<br>
<button onclick="manualSubmit()">Input Manual</button>
</div>

<script>
const yearMap={A:2022,B:2023,C:2024,D:2025,E:2026,F:2027,G:2028,H:2029,J:2030,K:2031,L:2032};
const monthMap={A:"Januari",B:"Februari",C:"Maret",D:"April",E:"Mei",F:"Juni",G:"Juli",H:"Agustus",J:"September",K:"Oktober",L:"November",M:"Desember"};
const areaMap={J:"NCR",X:"PM10"};

let locked=false;

function decode(code){
let prefix=code.substring(0,3).toUpperCase();
let y=yearMap[prefix[0]]||"Unknown";
let mName=monthMap[prefix[1]]||"Unknown";
let mIndex=Object.keys(monthMap).indexOf(prefix[1])+1;
let area=areaMap[prefix[2]]||"Unknown";

let now=new Date();
let prod=new Date(y,mIndex-1,1);

let diffDays=Math.floor((now-prod)/(1000*60*60*24));
let years=Math.floor(diffDays/365);
let months=Math.floor((diffDays%365)/30);
let days=diffDays%30;

let umurText="";
if(diffDays<30) umurText=`${diffDays} hari`;
else umurText=`${months} bulan ${days} hari`;

let status=years>=1?"bad":"good";
let text=years>=1?"EXPIRED":"DAPAT DIKIRIM";

return{y,mName,area,umurText,status,text};
}

function showResult(code){
if(!code) return;
let d=decode(code);
let el=document.getElementById("result");
el.innerHTML=`<div class='card ${d.status}'>
<div class='title'>${d.text}</div>
Kode : ${code}<br><br>
Tahun : ${d.y}<br>
Bulan : ${d.mName}<br>
Area : ${d.area}<br><br>
Umur : ${d.umurText}
</div>`;
}

function manualSubmit(){
let val=document.getElementById("manualCode").value.trim();
if(val.length<3){alert("Kode tidak valid");return;}
showResult(val);
}

const scanner=new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(devices=>{
scanner.start(devices[0].id,{fps:10,qrbox:250},(txt)=>showResult(txt));
});
</script>

<div style="position:fixed;bottom:20px;left:0;right:0;text-align:center;z-index:9999;">
  <button onclick="location.reload()">Scan Kamera</button>
  <button id="fileBtn">Scan dari File</button>
  <input type="file" id="fileInput" accept="image/*" style="display:none">
</div>

<script>
const fileInput=document.getElementById('fileInput');
document.getElementById('fileBtn').onclick=()=>fileInput.click();
fileInput.addEventListener('change', async (e)=>{
 const file=e.target.files[0];
 if(!file) return;
 try{
  const html5QrCode=new Html5Qrcode("reader");
  const result=await html5QrCode.scanFile(file,true);
  showResult(result);
 }catch{alert('Barcode tidak terbaca');}
});
</script>
</body>
</html>